<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auth Debug Test</title>
<style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    form { max-width: 400px; margin: auto; display: flex; flex-direction: column; gap: 1rem; }
    input, button { padding: 0.5rem; font-size: 1rem; }
    button { cursor: pointer; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
    h3 { margin-top: 2rem; }
</style>
</head>
<body>
<h2>Prueba de autenticación con Debug</h2>

<form id="authForm">
    <input type="text" id="username" placeholder="Usuario" required>
    <input type="password" id="password" placeholder="Contraseña" required>
    <button type="submit">Enviar credenciales</button>
</form>

<form id="twoFaForm" style="display:none;">
    <input type="text" id="twofa" placeholder="Código 2FA" required>
    <button type="submit">Verificar 2FA</button>
</form>

<h3>Respuesta del servidor:</h3>
<pre id="response"></pre>

<script>
const authForm = document.getElementById('authForm');
const twoFaForm = document.getElementById('twoFaForm');
const responseEl = document.getElementById('response');
let pendingId = null;

// Utilidad: intentar parsear JSON, si no, mostrar como texto plano (útil para errores PHP)
async function parseResponse(res) {
    const text = await res.text();
    try {
        return { ok: true, data: JSON.parse(text), raw: text };
    } catch {
        return { ok: false, data: null, raw: text };
    }
}

// Paso 1: Enviar usuario y contraseña
authForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    try {
        const res = await fetch('auth-endpoint.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });

        const parsed = await parseResponse(res);

        if (!parsed.ok) {
            responseEl.textContent = "⚠️ Respuesta NO JSON (posible error PHP):\n\n" + parsed.raw;
        } else if (!res.ok) {
            responseEl.textContent = `Error ${res.status}:\n\n` + JSON.stringify(parsed.data, null, 2);
        } else {
            responseEl.textContent = JSON.stringify(parsed.data, null, 2);
            if (parsed.data.pending_2fa && parsed.data.id) {
                pendingId = parsed.data.id;
                authForm.style.display = 'none';
                twoFaForm.style.display = 'flex';
            }
        }
    } catch (err) {
        responseEl.textContent = 'Error en la petición: ' + err.message;
    }
});

// Paso 2: Enviar código 2FA
twoFaForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const twofa = document.getElementById('twofa').value;

    try {
        const res = await fetch('verify-2fa.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: pendingId, code: twofa })
        });

        const parsed = await parseResponse(res);

        if (!parsed.ok) {
            responseEl.textContent = "⚠️ Respuesta NO JSON (posible error PHP):\n\n" + parsed.raw;
        } else if (!res.ok) {
            responseEl.textContent = `Error ${res.status}:\n\n` + JSON.stringify(parsed.data, null, 2);
        } else {
            responseEl.textContent = JSON.stringify(parsed.data, null, 2);
        }
    } catch (err) {
        responseEl.textContent = 'Error en la petición: ' + err.message;
    }
});
</script>
</body>
</html>
