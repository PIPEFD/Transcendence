server {
  listen 443 ssl http2;
  server_name localhost 127.0.0.1;

  ssl_certificate     /etc/ssl/fullchain.pem;
  ssl_certificate_key /etc/ssl/privkey.pem;
  # ssl_dhparam         /etc/ssl/dhparam.pem;

  include /etc/nginx/snippets/security.conf;

  # ---- SPA STATIC (frontend/dist) ----
  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri /index.html;
  }

  # ---- API (PHP-FPM en backend:9000) ----
  location /api/ {
    root /var/www/html/public;
    index index.php;
    try_files $uri $uri/ $uri.php =404;

    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO        $fastcgi_path_info;
    fastcgi_param HTTPS            on;
    fastcgi_pass backend:9000;  # PUERTO FIJO
  }

  location ~ ^/api/.*\.php$ {
    root /var/www/html/public;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param HTTPS on;
    fastcgi_pass backend:9000;  # PUERTO FIJO
  }

  # ---- WebSocket del juego ----
#   location /ws/ {
#     proxy_pass http://game-ws:9999/;   # PUERTO FIJO
#     include /etc/nginx/snippets/proxy_common.conf;
#     include /etc/nginx/snippets/ws_proxy.conf;
#   }

  # ---- Scope (opcional; comentar si no hay servicio) ----
  # location /scope/ {
  #   auth_basic "Restricted";
  #   auth_basic_user_file /run/secrets/scope_htpasswd;
  #   proxy_pass http://scope:4040/;
  #   include /etc/nginx/snippets/proxy_common.conf;
  # }

  location = /health { return 200 'ok'; add_header Content-Type text/plain; }
}
