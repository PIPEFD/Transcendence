# Map para manejar conexiones WebSocket
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Variables para rate limiting
map $request_uri $api_client_id {
    default         $binary_remote_addr;
    ~^/api/public/  '';  # No rate limit for public API
}

# Rate limiting zones
limit_req_zone $api_client_id zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/s;

# IP whitelist para monitoring
geo $internal {
    default         0;
    127.0.0.1      1;  # localhost
    172.16.0.0/12  1;  # Docker network
    192.168.0.0/16 1;  # Local network
}

# Bloqueo de User-Agents maliciosos
map $http_user_agent $bad_bot {
    default 0;
    ~*(curl|wget) 1;
    ~*(nikto|sqlmap|arachni|nessus) 1;
}

# Cache control para archivos est√°ticos
map $sent_http_content_type $expires {
    default                    off;
    text/html                  epoch;
    text/css                   max;
    application/javascript     max;
    ~image/                    max;
    ~font/                     max;
}