# Basic configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml application/json
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Rule processing configuration
SecRuleRemoveById 200003 # Disable scanning of multipart/form-data request body

# Enable audit logging in JSON format
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABDEFHIJKZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec/audit.log
SecAuditLogFormat JSON

# Anomaly Scoring Mode
SecDefaultAction "phase:1,log,auditlog,pass"
SecDefaultAction "phase:2,log,auditlog,pass"

# Add unique request ID
SecRule REQUEST_HEADERS:X-Request-ID "^$" \
    "id:1000001,phase:1,pass,t:none,nolog,\
    setvar:TX.request_id=%{uuid},\
    setenv:request_id=%{TX.request_id}"

SecRule REQUEST_HEADERS:X-Request-ID "^.+$" \
    "id:1000002,phase:1,pass,t:none,nolog,\
    setenv:request_id=%{MATCHED_VAR}"

# Include request ID in audit log
SecAuditLogStorageDir /var/log/modsec
SecAuditLogDirMode 0700
SecAuditLogFileMode 0600
SecAuditLogType Serial

# Temp files handling
SecTmpDir /tmp
SecUploadDir /tmp
SecUploadFileMode 0600

# Debug configurations
SecDebugLog /var/log/modsec/debug.log
SecDebugLogLevel 0